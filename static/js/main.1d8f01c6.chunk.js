(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{108:function(e,t,r){"use strict";r.r(t);var n,a=r(0),i=r.n(a),o=r(8),c=r.n(o),u=(r(94),r(15)),l=r.n(u),s=r(59),d=r(26),f=r(13),m=r(24);!function(e){e.training="training",e.escape="escape",e.collect="collect",e.snakes="snakes",e.rumble="rumble",e.avoid="avoid",e.word="word",e.boom="boom",e.horde="horde"}(n||(n={}));var p=function(e){return e.results.length>0};var v=r(153),b=r(140),y=r(64),h=r(157),g=r(152),E=r(158),x="#0E0E22",w=r(138),T=r(160),_=r(139),O=r(159),A=r(141),R=r(142),I=r(143),S=r(144),j=r(145),L=r(146),F=[0,.1,.2,.5,1,4],P=Object(E.a)({buttonContainer:{display:"flex",justifyContent:"space-between"},button:{minWidth:"32px !important"}}),k=function(e){var t=Object(a.useState)((e.currentTurnIndex+1).toString(10)),r=Object(f.a)(t,2),n=r[0],o=r[1],c=Object(a.useState)(!p(e.replay)),u=Object(f.a)(c,2),l=u[0],s=u[1],d=Object(a.useRef)(),m=P();Object(a.useEffect)(function(){o((e.currentTurnIndex+1).toString(10))},[e.currentTurnIndex]);var v=Object(a.useCallback)(function(){return e.setCurrentTurnIndex(function(t){return Math.min(e.replay.turns.length-1,t+1)})},[e]),y=Object(a.useCallback)(function(){return e.currentTurnIndex<e.replay.turns.length-1},[e]),g=Object(a.useCallback)(function(){void 0!==d.current&&window.clearInterval(d.current),d.current=void 0},[]),E=Object(a.useCallback)(function(){g(),d.current=window.setTimeout(function(){d.current=void 0,v()},1e3*e.delay)},[g,v,e.delay]);return Object(a.useEffect)(function(){l&&!y()?(g(),p(e.replay)&&s(!1)):l&&void 0===d.current&&y()&&E()},[l,E,g,v,y,e.currentTurnIndex,e.replay]),i.a.createElement("div",{style:{marginBottom:24}},i.a.createElement("div",null,i.a.createElement(h.a,{label:"Turn",margin:"normal",variant:"outlined",inputProps:{min:0},style:{width:"5em"},value:n,onChange:function(t){o(t.target.value);var r=parseInt(t.target.value,10)-1;isNaN(r)||e.replay&&e.setCurrentTurnIndex(Math.max(0,Math.min(parseInt(t.target.value,10)-1,e.replay.turns.length-1)))}}),i.a.createElement(h.a,{label:"Delay",select:!0,margin:"normal",variant:"outlined",style:{marginLeft:8,minWidth:"5em"},value:e.delay,onChange:function(t){var r=parseFloat(t.target.value);e.setDelay(r)},InputProps:{endAdornment:i.a.createElement(w.a,{position:"end"},"s")}},F.map(function(e){return i.a.createElement(T.a,{key:e,value:e},""+e)})),i.a.createElement(_.a,{style:{marginTop:24,marginLeft:0},label:"3D",control:i.a.createElement(O.a,{checked:e.mode3d,onChange:function(t){return e.setMode3d(t.target.checked)}})})),i.a.createElement("div",{className:m.buttonContainer},i.a.createElement(b.a,{color:"primary",size:"small",variant:"contained",className:m.button,disabled:e.currentTurnIndex<=0,onClick:function(){return e.setCurrentTurnIndex(0)}},i.a.createElement(A.a,null)),i.a.createElement(b.a,{color:"primary",size:"small",variant:"contained",className:m.button,disabled:e.currentTurnIndex<=0,onClick:function(){return e.setCurrentTurnIndex(e.currentTurnIndex-1)}},i.a.createElement(R.a,null)),i.a.createElement(b.a,{color:"primary",size:"small",variant:"contained",className:m.button,disabled:e.currentTurnIndex>=e.replay.turns.length-1,onClick:function(){return l?(g(),void s(!1)):(g(),void s(!0))}}," ",l?i.a.createElement(I.a,null):i.a.createElement(S.a,null)),i.a.createElement(b.a,{color:"primary",size:"small",variant:"contained",className:m.button,disabled:e.currentTurnIndex>=e.replay.turns.length-1,onClick:v},i.a.createElement(j.a,null)),i.a.createElement(b.a,{color:"primary",size:"small",variant:"contained",className:m.button,disabled:e.currentTurnIndex>=e.replay.turns.length-1,onClick:function(){return e.replay&&e.setCurrentTurnIndex(e.replay.turns.length-1)}},i.a.createElement(L.a,null))))},C=r(73),B=r(147),D=r(148),U=r(149),N=r(150),M=r(151),W=r(44),H=r.n(W),G=function(e){var t=Object(a.useState)((e.traceStart+1).toString(10)),r=Object(f.a)(t,2),n=r[0],o=r[1],c=Object(a.useState)(!1),u=Object(f.a)(c,2),l=u[0],m=u[1];Object(a.useEffect)(function(){var t=l?e.currentTurn.turn-1:Math.min(e.traceStart,e.currentTurn.turn-1);e.setTraceStart(t),o((t+1).toString(10))},[e,l]);var p=e.replay.results.length>0&&e.currentTurn.turn===e.replay.turns[e.replay.turns.length-1].turn?e.replay.results.map(function(t){var r=e.currentTurn.players.findIndex(function(e){return e.name===t.name});return Object(d.a)({},t,{life:r>=0&&e.currentTurn.players[r].life||0,index:r})}):e.currentTurn.players.map(function(e,t){return Object(d.a)({},e,{index:t})});return i.a.createElement("div",{style:{marginBottom:24}},i.a.createElement(B.a,{padding:"none"},i.a.createElement(D.a,null,i.a.createElement(U.a,null,i.a.createElement(N.a,{align:"center"},"Trace"),i.a.createElement(N.a,{align:"center"},"Name"),i.a.createElement(N.a,{align:"center"},"Life"),i.a.createElement(N.a,{align:"center"},"Move"),i.a.createElement(N.a,{align:"center"},"Score"))),i.a.createElement(M.a,null,p.map(function(t){return i.a.createElement(Y,{key:t.name,player:t,traced:e.tracedPlayers.indexOf(t.index)>=0,setTraced:function(r){return e.setTracedPlayers(function(e){return r?[].concat(Object(s.a)(e),[t.index]):e.filter(function(e){return e!==t.index})})}})}))),i.a.createElement(g.a,{in:e.tracedPlayers.length>0},i.a.createElement("div",null,i.a.createElement(h.a,{label:"Trace Start",margin:"normal",variant:"outlined",inputProps:{min:0},style:{width:"6em"},disabled:l,value:n,onChange:function(t){o(t.target.value);var r=parseInt(t.target.value,10)-1;isNaN(r)||e.setTraceStart(Math.max(0,Math.min(r,e.currentTurn.turn-1)))},onBlur:function(t){o(function(t){var r=parseInt(t,10);return(isNaN(r)?e.currentTurn.turn:Math.min(r,e.currentTurn.turn)).toString(10)})}}),i.a.createElement(_.a,{style:{marginTop:24,marginLeft:0},label:"Current turn",control:i.a.createElement(O.a,{checked:l,onChange:function(e){return m(e.target.checked)}})}))))},X=[void 0,"#DA4A79",H()("#DA4A79").alpha(.7).hex(),H()("#DA4A79").alpha(.4).hex()],Y=function(e){var t=e.player;return i.a.createElement(U.a,{style:{background:t.place&&X[t.place]}},i.a.createElement(N.a,{align:"center"},i.a.createElement(O.a,{style:{padding:0},onChange:function(t){e.setTraced(t.target.checked)},checked:e.traced})),i.a.createElement(N.a,{align:"center"},t.name),i.a.createElement(N.a,{align:"center"},t.life),i.a.createElement(N.a,{align:"center"},t.moves),i.a.createElement(N.a,{align:"center"},t.score))},V=Object(E.a)({root:{flexShrink:0,width:320},paper:{width:320,background:"".concat("#272863"," !important"),padding:30,borderTopLeftRadius:30,borderBottomLeftRadius:30,border:"none !important"}}),z=function(e){var t=Object(a.useState)(function(){return window.localStorage.getItem("serverAddress")||"ws://localhost:63189"}),r=Object(f.a)(t,2),n=r[0],o=r[1],c=e.replay&&e.replay.turns[e.currentTurnIndex],u=Object(a.useState)(.1),s=Object(f.a)(u,2),d=s[0],E=s[1],x=V();return i.a.createElement(v.a,{variant:"permanent",anchor:"right",className:x.root,classes:{paper:x.paper}},i.a.createElement("input",{id:"replayFileInput",type:"file",style:{display:"none"},onChange:function(){var t=Object(m.a)(l.a.mark(function t(r){var n,a;return l.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(r.preventDefault(),!(null!=r.target.files&&r.target.files.length>0)){t.next=8;break}return n=r.target.files[0],r.target.value="",t.next=6,J(n);case 6:a=t.sent,e.onReplayFileUploaded(a);case 8:case"end":return t.stop()}},t)}));return function(e){return t.apply(this,arguments)}}()}),i.a.createElement("label",{htmlFor:"replayFileInput"},i.a.createElement(b.a,{color:"primary",variant:"contained",component:"div",style:{width:"100%"}},"Load replay")),e.webSocket?i.a.createElement(i.a.Fragment,null,i.a.createElement(y.a,{variant:"body1",style:{marginTop:16}},"Connected to ",e.webSocket.url),i.a.createElement(b.a,{color:"secondary",variant:"contained",onClick:e.onCloseWebsocket,style:{marginBottom:8}},"Disconnect")):i.a.createElement(i.a.Fragment,null,i.a.createElement(h.a,{label:"Host",margin:"normal",variant:"outlined",value:n,onChange:function(e){o(e.target.value),window.localStorage.setItem("serverAddress",e.target.value)},onKeyPress:function(t){"Enter"===t.key&&(t.preventDefault(),e.onConnectWebsocket(n))}}),i.a.createElement(b.a,{color:"primary",variant:"contained",onClick:function(){return e.onConnectWebsocket(n)}},"Connect")),i.a.createElement("div",{style:{marginBottom:16}}),i.a.createElement(g.a,{in:void 0!==e.replay},e.replay&&i.a.createElement(k,{replay:e.replay,currentTurnIndex:e.currentTurnIndex,delay:d,setDelay:E,setCurrentTurnIndex:e.setCurrentTurnIndex,mode3d:e.mode3d,setMode3d:e.setMode3d}),e.replay&&c&&i.a.createElement(G,{replay:e.replay,currentTurn:c,tracedPlayers:e.tracedPlayers,setTracedPlayers:e.setTracedPlayers,traceStart:e.traceStart,setTraceStart:e.setTraceStart}),e.replay&&p(e.replay)&&i.a.createElement(b.a,{variant:"contained",color:"secondary",onClick:function(){var t=new Blob([JSON.stringify(e.replay)],{type:"application/json;charset=utf-8"});C.saveAs(t,"replay.json")}},"Save replay"),i.a.createElement("div",{style:{marginBottom:30}})))};function J(e){return K.apply(this,arguments)}function K(){return(K=Object(m.a)(l.a.mark(function e(t){return l.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(e){var r=new FileReader;r.readAsText(t),r.onload=function(t){var n=r.result;e(n)}}));case 1:case"end":return e.stop()}},e)}))).apply(this,arguments)}var Q=r(10),Z="\nattribute float a_transition;\nattribute vec3 a_pos1;\nattribute vec3 a_pos2;\nattribute vec3 a_normal1;\nattribute vec3 a_normal2;\nattribute vec2 a_uv;\nattribute vec4 a_tint;\nuniform mat4 u_mv;\nuniform mat4 u_mvp;\nvarying vec3 v_normal;\nvarying vec2 v_uv;\nvarying vec4 v_tint;\n\nvoid main() {\n  vec3 pos = a_pos1 * a_transition + a_pos2 * (1.0 - a_transition);\n  gl_Position = u_mvp * vec4(pos, 1.);\n  vec3 normal = a_normal1 * a_transition + a_normal2 * (1.0 - a_transition);\n  v_normal = vec3(u_mv * vec4(normal, 0.0));\n  v_uv = a_uv;\n  v_tint = a_tint;\n}\n",q="\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nvarying vec3 v_normal;\nvarying vec2 v_uv;\nvarying vec4 v_tint;\nuniform sampler2D u_texture;\n\nvoid main() {\n  gl_FragColor = texture2D(u_texture, v_uv.st).rgba;\n  gl_FragColor.rgb *= v_tint.rgb;\n  gl_FragColor *= v_tint.a;\n  float diffuse = dot(v_normal, vec3(0,0,1));\n  float ambient = 0.2;\n  gl_FragColor.rgb *= diffuse * 0.8 + ambient;\n}\n",$=new Float32Array([1,1,1,1]),ee=Q.a.create(),te=Q.a.create();function re(e,t,r){var n=e.createShader(t);return e.shaderSource(n,r),e.compileShader(n),n}function ne(e,t,r){var n=e.getAttribLocation(t,"a_transition"),a=e.getAttribLocation(t,"a_pos1");e.enableVertexAttribArray(a);var i=e.getAttribLocation(t,"a_pos2");e.enableVertexAttribArray(i);var o=e.getAttribLocation(t,"a_normal1"),c=e.getAttribLocation(t,"a_normal2");e.enableVertexAttribArray(c);var u=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,u),e.bufferData(e.ARRAY_BUFFER,new Float32Array(function(e){for(var t=[],r=1/e.width,n=1/e.height,a=.5*r,i=.5*n,o=0;o<e.height;o+=16)for(var c=0;c<e.width;c+=16){var u=c*r,l=o*n,s=u+16*r,d=l+16*n;t.push(u+a,l+i,u+a,d-i,s-a,l+i,s-a,d-i)}return t}(r)),e.STATIC_DRAW);var l=e.getAttribLocation(t,"a_uv");return e.enableVertexAttribArray(l),{program:t,uvBuffer:u,transitionAttribLoc:n,pos1AttribLoc:a,pos2AttribLoc:i,normal1AttribLoc:o,normal2AttribLoc:c,uvAttribLoc:l,tintAttribLoc:e.getAttribLocation(t,"a_tint"),mvUniformLoc:e.getUniformLocation(t,"u_mv"),mvpUniformLoc:e.getUniformLocation(t,"u_mvp"),textureUniformLoc:e.getUniformLocation(t,"u_texture")}}function ae(){return(ae=Object(m.a)(l.a.mark(function e(t){var r,n,a,i,o;return l.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,ce();case 2:return r=e.sent,n=oe(t,r),a=t.createProgram(),t.attachShader(a,re(t,t.VERTEX_SHADER,Z)),t.attachShader(a,re(t,t.FRAGMENT_SHADER,q)),t.linkProgram(a),t.useProgram(a),i=ne(t,a,r),t.enable(t.BLEND),t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA),o=H()(x).gl(),t.clearColor(o[0],o[1],o[2],1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),e.abrupt("return",{gl:t,programInfo:i,atlasTexture:n});case 18:case"end":return e.stop()}},e)}))).apply(this,arguments)}function ie(e,t){var r=e.gl,n=e.programInfo;!function(e,t,r){var n=e.canvas.clientWidth,a=e.canvas.clientHeight;e.canvas.width=n,e.canvas.height=a,e.viewport(0,0,n,a);var i=n>a?n/a:1,o=a>n?a/n:1,c=Q.a.fromQuat(ee,r);e.uniformMatrix4fv(t.mvUniformLoc,!1,c);var u=Q.a.identity(te);Q.a.ortho(u,-i,i,-o,o,-10,10),Q.a.mul(u,u,c),e.uniformMatrix4fv(t.mvpUniformLoc,!1,u)}(r,n,t),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),r.useProgram(n.program),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,e.atlasTexture),r.uniform1i(n.textureUniformLoc,0),r.bindBuffer(r.ARRAY_BUFFER,n.uvBuffer)}function oe(e,t){var r=e.createTexture();if(r<1)throw Error("Failed to create atlasTexture");return e.bindTexture(e.TEXTURE_2D,r),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.generateMipmap(e.TEXTURE_2D),r}function ce(){return ue.apply(this,arguments)}function ue(){return(ue=Object(m.a)(l.a.mark(function e(){var t;return l.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return(t=new Image).src="atlas.png",console.log("Loading atlas image..."),e.abrupt("return",new Promise(function(e){t.onload=function(){console.log("Loaded atlas successfully."),e(t)}}));case 4:case"end":return e.stop()}},e)}))).apply(this,arguments)}var le=new Float32Array([0,0,1]);var se=new Float32Array([0,2,0,1]),de=function(e){return function(t,r,n){var a=!0,i=!1,o=void 0;try{for(var c,u=e[Symbol.iterator]();!(a=(c=u.next()).done);a=!0){var l=(0,c.value)(t,r,n);if(0!==l.length)return l}}catch(s){i=!0,o=s}finally{try{a||null==u.return||u.return()}finally{if(i)throw o}}return[]}},fe=function(e,t,r){var n="ABCDEFGHIJKLMNOPe".indexOf(e);return"."===e||-1!==n?[{spriteIndex:(t+r)%2}]:[]},me=function(e,t,r){return"+"===e?[{spriteIndex:113}]:[]},pe=de([fe,function(e,t,r){var n="#X~".indexOf(e);return-1===n?[]:[{spriteIndex:2+n}]},function(e,t,r){return-1==="o&".indexOf(e)?[]:[{spriteIndex:6}]},function(e,t,r){return"@"===e?[{spriteIndex:5}]:[]},function(e,t,r){return"*"===e?[{spriteIndex:7}]:[]}]),ve=de([function(e,t,r){var n="abcdefghijklmnopqrstuuwxyz".indexOf(e);return-1===n?[]:[{spriteIndex:17+n}]},pe]),be=de([me,function(e,t,r){return"e"===e?fe(e,t,r).concat({spriteIndex:112,tint:se}):[]},pe]),ye=de([function(e,t,r){var n="987654321".indexOf(e);return-1===n?[]:[{spriteIndex:8+n}]},function(e,t,r){var n="Y".indexOf(e);return-1===n?[]:[{spriteIndex:2+n}]},me,pe]),he=function(e,t,r){var n="ABCDEFGHIJKLMNOP".indexOf(e);return-1===n?[]:[{spriteIndex:48+4*n}]},ge=Q.c.create(),Ee=Q.c.create(),xe=function(e){return function(t,r){var n=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,n);var a=new Float32Array(r.width*r.height*4*3);function i(e,t){a[3*e]=t[0],a[3*e+1]=t[1],a[3*e+2]=t[2]}for(var o=0;o<r.height;++o)for(var c=0;c<r.width;++c){var u=4*(o*r.width+c);i(u,e(r,c,o+1)),i(u+1,e(r,c,o)),i(u+2,e(r,c+1,o+1)),i(u+3,e(r,c+1,o))}return t.bufferData(t.ARRAY_BUFFER,a,t.STATIC_DRAW),n}},we=xe(function(e,t,r){var n=2*t/e.width-1,a=2*r/e.height-1,i=Q.c.set(ge,0,0,.35);return Q.c.rotateY(i,i,Ee,n*Math.PI),Q.c.add(i,i,[.6,0,0]),Q.c.rotateZ(i,i,Ee,a*Math.PI),i}),Te=xe(function(e,t,r){var n=2*t/e.width-1,a=2*r/e.height-1,i=Q.c.set(ge,0,0,1);return Q.c.rotateY(i,i,Ee,n*Math.PI),Q.c.rotateZ(i,i,Ee,a*Math.PI),i}),_e=xe(function(e,t,r){var n=2*t/e.width-1,a=2*r/e.height-1;return Q.c.set(ge,n,a,0)});function Oe(e,t,r,n,a){for(var i=r-a;i<=r+a;++i)for(var o=n-a;o<=n+a;++o){e[(i+t.width)%t.width+(o+t.height)%t.height*t.width]=!0}return e}function Ae(e){var t=new Array(e.mapDim.width*e.mapDim.height).fill(!1),r=!0,n=!1,a=void 0;try{for(var i,o=e.turns[Symbol.iterator]();!(r=(i=o.next()).done);r=!0){var c=i.value,u=!0,l=!1,s=void 0;try{for(var d,f=e.tracedPlayers[Symbol.iterator]();!(u=(d=f.next()).done);u=!0){var m=d.value,p=c.players[m];Oe(t,e.mapDim,p.x,p.y,e.viewRadius)}}catch(v){l=!0,s=v}finally{try{u||null==f.return||f.return()}finally{if(l)throw s}}}}catch(v){n=!0,a=v}finally{try{r||null==o.return||o.return()}finally{if(n)throw a}}return t}var Re=r(74),Ie="^v><",Se=Object(E.a)({root:{flexGrow:1,width:"100%",height:"100%",touchAction:"none"}}),je=new Re.Howl({src:"explosion.wav"});function Le(e){switch(e){case n.training:case n.escape:case n.collect:case n.snakes:case n.avoid:case n.rumble:return pe;case n.horde:return be;case n.boom:return ye;case n.word:return ve;default:return pe}}var Fe=1e3;var Pe=function(e){var t=Se(),r=Object(a.useRef)(null),n=Object(a.useState)(),o=Object(f.a)(n,2),c=o[0],u=o[1],l=Object(a.useRef)(null),s=Object(a.useRef)(e.currentTurnIndex),m=Object(a.useRef)(e.mode3d),p=Object(a.useRef)([]),v=Object(a.useRef)([]),b=Object(a.useRef)(null),y=Object(a.useRef)(e.mode3d?0:1),h=Object(a.useState)(0),g=Object(f.a)(h,2),E=g[0],x=g[1],w=Object(a.useState)(Q.b.create()),T=Object(f.a)(w,2),_=T[0],O=T[1],A=function(){var e=Object(a.useState)(ke),t=Object(f.a)(e,2),r=t[0],n=t[1];return Object(a.useEffect)(function(){function e(){n(ke())}return window.addEventListener("resize",e),function(){return window.removeEventListener("resize",e)}},[]),r}();return Object(a.useEffect)(function(){if(null!=r.current){console.log("Initializing WebGL");var e=r.current;(function(e){return ae.apply(this,arguments)})(e.getContext("webgl")||e.getContext("experimental-webgl")).then(function(e){u(e)})}},[]),Object(a.useEffect)(function(){if(void 0!==c){var t,r,n={width:e.replay.map_width,height:e.replay.map_height};if(!l.current||(t=l.current.mapDim,r=n,t.width!==r.width||t.height!==r.height))console.log("Recreating vertex pos buffer for map dims: ".concat(n)),l.current={mapDim:n,planePosVertexBuffer:_e(c.gl,n),torusNormalVertexBuffer:Te(c.gl,n),torusPosVertexBuffer:we(c.gl,n)}}},[e.replay,c]),Object(a.useEffect)(function(){if(void 0!==c){var t=performance.now(),r={width:e.replay.map_width,height:e.replay.map_height},n=l.current,a=function(e,t,r,n,a,i){return function(o,c){var u=arguments.length>2&&void 0!==arguments[2]?arguments[2]:$,l=e.gl,s=e.programInfo;l.bindBuffer(l.ARRAY_BUFFER,r),l.vertexAttribPointer(s.pos1AttribLoc,3,l.FLOAT,!1,0,4*(c.y*t.width+c.x)*3*4),l.bindBuffer(l.ARRAY_BUFFER,n),l.vertexAttribPointer(s.pos2AttribLoc,3,l.FLOAT,!1,0,4*(c.y*t.width+c.x)*3*4),l.vertexAttrib3fv(s.normal1AttribLoc,le),l.bindBuffer(l.ARRAY_BUFFER,a),l.vertexAttribPointer(s.normal2AttribLoc,3,l.FLOAT,!1,0,4*(c.y*t.width+c.x)*3*4),l.bindBuffer(l.ARRAY_BUFFER,s.uvBuffer),l.vertexAttribPointer(s.uvAttribLoc,2,l.FLOAT,!1,0,o<<5),l.vertexAttrib4fv(s.tintAttribLoc,u),l.vertexAttrib1f(s.transitionAttribLoc,i),l.drawArrays(l.TRIANGLE_STRIP,0,4)}}(c,r,n.planePosVertexBuffer,n.torusPosVertexBuffer,n.torusNormalVertexBuffer,y.current);if(e.currentTurnIndex>s.current){var i=function(e,t,r){if(e.turns.length<=t)return[];var n=e.turns[t],a=[],i=!0,o=!1,c=void 0;try{for(var u,l=n.players[Symbol.iterator]();!(i=(u=l.next()).done);i=!0){var s=u.value;s.life<=0&&s.moves===n.turn-1&&function(){var t=new Float32Array([1,1,1,1]),n={x:s.x,y:e.map_height-s.y-1},i={setOpacity:function(e){t[3]=e},remove:function(){r(i)},render:function(e){e(114,n,t)}};a.push(i)}()}}catch(d){o=!0,c=d}finally{try{i||null==l.return||l.return()}finally{if(o)throw c}}return a}(e.replay,e.currentTurnIndex,function(e){var t=p.current.indexOf(e);t>=0&&p.current.splice(t,1)});p.current=p.current.concat(i),v.current=v.current.concat(i.map(function(e){return r=t,n=e,je.play(),function e(t){return t-r>Fe?(n.remove(),null):(n.setOpacity(1-(t-r)/Fe),e)};var r,n}))}e.mode3d!==m.current&&(b.current=function(e){return function t(r){if(r-e.startTime>e.duration)return e.set(e.to),null;var n=function(e){var t=2*e;if(t<1)return t*t*t/2;var r=t-2;return(2+r*r*r)/2}((r-e.startTime)/e.duration);return e.set((1-n)*e.from+n*e.to),t}}({startTime:t,duration:1e3,from:y.current,to:e.mode3d?0:1,set:function(e){return y.current=e}})),v.current=v.current.map(function(e){return e(t)}).filter(function(e){return!!e}),b.current&&(b.current=b.current(t)),function(e){if(ie(e.myGL,e.rotation),!(e.replay.turns.length<=e.currentTurnIndex)){for(var t=e.replay.turns[e.currentTurnIndex],r={width:e.replay.map_width,height:e.replay.map_height},n=new Float32Array([1.5,1.5,1.5,1]),a=new Float32Array([2,2,2,1]),i=Ae({mapDim:r,turns:e.replay.turns.slice(e.traceStart,e.currentTurnIndex),tracedPlayers:e.tracedPlayers,viewRadius:e.replay.view_radius}),o=Ae({mapDim:r,turns:[e.replay.turns[e.currentTurnIndex]],tracedPlayers:e.tracedPlayers,viewRadius:e.replay.view_radius}),c=0;c<e.replay.map_height;++c)for(var u=e.replay.map_height-c-1,l=0;l<e.replay.map_width;++l){var s={x:l,y:u},d=l+c*e.replay.map_width,f=t.map.charAt(d),m=o[d]&&a||i[d]&&n||void 0,p=!0,v=!1,b=void 0;try{for(var y,h=e.spritePicker(f,l,u)[Symbol.iterator]();!(p=(y=h.next()).done);p=!0){var g=y.value;e.drawSprite(g.spriteIndex,s,g.tint||m)}}catch(U){v=!0,b=U}finally{try{p||null==h.return||h.return()}finally{if(v)throw b}}}for(var E=new Float32Array([1,1,1,.3]),x=e.traceStart;x<e.currentTurnIndex;++x)for(var w=e.replay.turns[x],T=0;T<w.players.length;++T)if(!(e.tracedPlayers.indexOf(T)<0)){var _=w.players[T],O=Ie.indexOf(_.bearing),A={x:_.x,y:e.replay.map_height-_.y-1},R=he(_.name,_.x,_.y)[0];e.drawSprite(R.spriteIndex+O,A,E)}var I=!0,S=!1,j=void 0;try{for(var L,F=t.players[Symbol.iterator]();!(I=(L=F.next()).done);I=!0){var P=L.value;if(!(P.life<=0)){var k=he(P.name,P.x,P.y)[0],C=Ie.indexOf(P.bearing),B=e.replay.map_height-P.y-1,D={x:P.x,y:B};e.drawSprite(k.spriteIndex+C,D)}}}catch(U){S=!0,j=U}finally{try{I||null==F.return||F.return()}finally{if(S)throw j}}e.deathSprites.forEach(function(t){return t.render(e.drawSprite)})}}(Object(d.a)({myGL:c,spritePicker:Le(e.replay.mode),drawSprite:a,rotation:Q.b.scale(Q.b.create(),_,1-y.current),deathSprites:p.current},e)),(v.current.length>0||b.current)&&x(function(e){return e+1})}},[c,e,_,E,A]),Object(a.useEffect)(function(){s.current=e.currentTurnIndex,m.current=e.mode3d}),i.a.createElement("div",{className:t.root},i.a.createElement("canvas",{onPointerMove:function(t){if(0!==t.buttons&&e.mode3d){var r=.05*t.movementY,n=.05*t.movementX;O(function(e){var t=Q.b.create();return Q.b.rotateX(t,e,r),Q.b.rotateY(t,t,n),t})}},ref:r,style:{width:"100%",height:"100%"}},"Your browser does not support HTML5 canvas."))};function ke(){var e="object"===typeof window;return{width:e?window.innerWidth:void 0,height:e?window.innerHeight:void 0}}var Ce=r(75),Be=r(110),De=r(161),Ue=r(155),Ne=r(156),Me=r(154);var We=Object(Ce.a)({palette:{type:"dark",primary:{main:"#DA4A79"},secondary:{main:"#7A7EBC"},background:{default:x}},overrides:{MuiPaper:{root:{backgroundColor:"#272863"}}}}),He=Object(E.a)({root:{display:"flex",height:"100%",width:"100%",top:0,position:"fixed"}});function Ge(){return(Ge=Object(m.a)(l.a.mark(function e(){var t,r,n;return l.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=new URLSearchParams(document.location.search),r=t.get("replay_url")){e.next=4;break}return e.abrupt("return",void 0);case 4:return e.next=6,fetch(r);case 6:return n=e.sent,e.abrupt("return",n.text());case 8:case"end":return e.stop()}},e)}))).apply(this,arguments)}var Xe=i.a.forwardRef(function(e,t){return i.a.createElement(Be.a,Object.assign({direction:"up",ref:t},e))});function Ye(e,t){return Ve.apply(this,arguments)}function Ve(){return(Ve=Object(m.a)(l.a.mark(function e(t,r){return l.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(e,n){try{var a=new WebSocket(t);return a.onopen=function(t){e(a)},a.onerror=function(r){e({message:"Error establishing WebSocket to ".concat(t)})},a.onmessage=function(e){var t=JSON.parse(e.data);if(void 0!==t.max_turns)t.mode||r.onError("Warning: Header is missing mode-field - you're probably connected to an old bots version, using default sprites."),r.onHeader(t);else if(void 0!==t.results)r.onResults(t);else{if(void 0===t.turn)throw Error("unexpected message: ".concat(e.data));r.onTurn(t)}},a.onclose=r.onDisconnect,a}catch(i){e({message:i.toString()})}}));case 1:case"end":return e.stop()}},e)}))).apply(this,arguments)}Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));c.a.render(i.a.createElement(function(){var e=He(),t=Object(a.useState)(void 0),r=Object(f.a)(t,2),n=r[0],o=r[1],c=Object(a.useState)(0),u=Object(f.a)(c,2),p=u[0],v=u[1],b=Object(a.useState)(void 0),y=Object(f.a)(b,2),h=y[0],g=y[1],E=Object(a.useState)([]),x=Object(f.a)(E,2),w=x[0],T=x[1],_=Object(a.useState)(0),O=Object(f.a)(_,2),A=O[0],R=O[1],I=Object(a.useState)(!1),S=Object(f.a)(I,2),j=S[0],L=S[1],F=Object(a.useState)(void 0),P=Object(f.a)(F,2),k=P[0],C=P[1],B=function(e){var t=function(e){try{var t=JSON.parse(e);return t.mode?{replay:t}:{replay:t,warning:"Warning: Replay is missing mode-field - it's probably from an old bots version, using default sprites."}}catch(r){return r.toString()}}(e);"string"===typeof t?C(t):(t.warning&&C(t.warning),g(function(e){e&&e.close()}),v(0),o(t.replay))};return Object(a.useEffect)(function(){(function(){return Ge.apply(this,arguments)})().then(function(e){e&&B(e)})},[]),i.a.createElement(Me.a,{theme:We},i.a.createElement(De.a,null),i.a.createElement(Ue.a,{open:void 0!==k,onClose:function(){return C(void 0)},TransitionComponent:Xe},i.a.createElement(Ne.a,null,k)),i.a.createElement("div",{className:e.root},i.a.createElement("div",{style:{position:"relative",width:"100%",height:"100%"}},n&&i.a.createElement(Pe,{replay:n,currentTurnIndex:p,tracedPlayers:w,traceStart:A,mode3d:j}),i.a.createElement(Be.a,{direction:"up",in:void 0===n,timeout:{enter:0,exit:500}},i.a.createElement("div",{style:{position:"absolute",width:"100%",height:"100%",top:0,left:0,background:"url(BotsSticker.svg) no-repeat top"}}))),i.a.createElement(z,{replay:n,webSocket:h,currentTurnIndex:p,setCurrentTurnIndex:v,tracedPlayers:w,setTracedPlayers:T,mode3d:j,setMode3d:L,traceStart:A,setTraceStart:R,onConnectWebsocket:function(){var e=Object(m.a)(l.a.mark(function e(t){var r;return l.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Ye(t,{onHeader:function(e){o(Object(d.a)({},e,{turns:[],results:[]}))},onTurn:function(e){o(function(t){return Object(d.a)({},t,{turns:[].concat(Object(s.a)(t.turns),[e])})})},onResults:function(e){o(function(t){return Object(d.a)({},t,e)})},onDisconnect:function(){g(void 0)},onError:function(e){C(e)}});case 2:if(void 0===(r=e.sent).message){e.next=8;break}return C(r.message),e.abrupt("return");case 8:g(r);case 9:v(0),o(void 0);case 11:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}(),onCloseWebsocket:function(){return g(function(e){e&&e.close()})},onReplayFileUploaded:B})))},null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(function(e){e.unregister()})},89:function(e,t,r){e.exports=r(108)},94:function(e,t,r){}},[[89,1,2]]]);
//# sourceMappingURL=main.1d8f01c6.chunk.js.map